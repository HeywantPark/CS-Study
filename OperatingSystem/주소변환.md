# 주소변환(Address Translation)

**가상 주소를 물리 주소로 변환**하는 것을 **주소변환** 이라고 합니다.  
주소 변환은 하드웨어적으로 이루어지며 프로세서가 메모리 참조 명령어를 수행할 때마다 발생합니다. 

운영 체제는 메모리 관리자 역할을 수행하며 물리 메모리의 할당 및 회수, 가상 주소 공간과 물리 주소 공간의
매핑 등을 담당합니다. 이를 위해 운영 체제는 메모리의 사용 현황을 파악하고 있어야 하며 프로세스 간의 메모리 보호와 공유를 적절히 제어해야 한다.

---

# 동적 재배치(Dynamic Relocation)
동적 재배치는 프로세스의 주소 공간을 실행 시간에 동적으로 물리 메모리 상의 다른 위치로 이동할 수 있게 해주는 기술로 이를 통해 운영 체제는 메모리 관리를 보다 유연하게 할 수 있습니다.

동적 재배치는 메모리 단편화 문제를 해결할 수 있지만, 현대에는 페이징이나 세그먼테이션 등의 발전된 메모리 관리 기법을 사용하고 있습니다. 

동적 재배치를 구현하기 위해서는 CPU에서 베이스 레지스터와 바운드 레지스터라는 두개의 하드웨어가 사용됩니다. 

### 베이스 레지스터
- 역할 : 프로세스의 주소 공간이 실제 물리 메모리 상의 위치한 시작 주소를 저장하는 레지스터
- 주소 변환 과정에서 프로세스가 생성한 가상 주소에 베이스 레지스터 값을 더하여 실제 물리 주소를 계산
- 
### 바운드 레지스터
- 역할 : 바운드 레지스터는 프로세스의 주소 공간 크기 또는 주소 공간의 마지막 주소를 저장하는 레지스터
- 프로세스가 생성한 가상 주소가 바운드 레지스터에 저장된 범위 내에 있는지 확인하여 메모리 보호 기능을 수행. 만약 가상 주소가 바운드 레지스터에 저장된 범위를 벗어나면 하드웨어는 예외를 발생시켜 운영 체제에 알림.

---
## 주소 변환 과정

1. 프로세스가 생성한 가상 주소에 베이스 레지스터 값을 더하여 실제 물리 주소를 계산한다.
2. 계산된 물리 주소가 바운드 레지스터 값의 범위 내에 있는지 확인한다.  
3. 물리 주소가 유효한 범위 내에 있다면 해당 주소의 메모리에 접근할 수 있도록 허용한다.
4. 만약 물리 주소가 바운드 레지스터 값의 범위를 벗어난다면 하드웨어는 예외를 발생시켜 운영 체제에 알린다. 
 
---

## 동적 재배치 과정
운영 체제는 필요에 따라 프로세스의 주소 공간을 물리 메모리 상의 다른 영역으로 이동시킬 수 있다.

1. 주소 공간을 이동시킬 때 운영 체제는 해당 프로세스의 베이스 레지스터 값을 변경하여 새로운 물리 메모리 영역을 가리키도록 한다. 또한 바운드 레지스터 값도 새로운 주소 공간 크기에 맞게 조정한다.
3. 프로세스의 상태 정보를 저장하는 자료구조인 PCB에 변경된 베이스와 바운드 레지스터 값을 저장한다.
4. 프로세스가 다시 실행될 때 PCB에 저장된 베이스와 바운드 레지스터 값이 CPU의 레지스터에 로드되어 프로세스는 새로운 물리 메모리 영역에서 실행된다. 

---

## 주소 변환을 위한 하드웨어 : MMU(Memory Management Unit)
- MMU : 베이스와 바운드 레지스터를 사용하여 주소 변환과 메모리 보호를 담당
- 프로세스 전환 시 작업 :
  1. 현재 프로세스의 베이스, 바운드 값을 PCB(프로세스 제어 블록)에 저장.
  2. 새 프로세스 실행 시, 베이스와 바운드 값 복원

---
## 운영체제 개입 시점
1. 프로세스 생성 시 : 빈 물리 메모리 슬롯을 검색하여 프로세스 주소 공간에 할당.
2. 프로세스 종료 시 : 사용한 메모리를 회수하고 빈공간 리스트 업데이트.
3. 컨텍스트 스위칭 발생 시 : 현재 프로세스의 레지스터 값을 저장하고 새 프로세스의 PCB에서 값을 읽어와 CPU 레지스터에 로드
5. 메모리 보호 위반 시 : 운영 체제는 예외 핸들러를 설정하여 메모리 접근 위반 예외 처리. 위반 발생 시 프로세스를 종료하거나 적절한 조치를 수행.

---
### 참고자료
- https://inblog.ai/soultree/os-%ED%95%98%EB%93%9C%EC%9B%A8%EC%96%B4-%EA%B8%B0%EB%B0%98-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A3%BC%EC%86%8C-%EB%B3%80%ED%99%98-18951
- https://hotechstory.tistory.com/159
- https://rxdcxdrnine.tistory.com/25
